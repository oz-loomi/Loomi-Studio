name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -Eeuo pipefail

            APP_ROOT=/var/www/loomi-studio
            RELEASES_DIR="$APP_ROOT/releases"
            SHARED_DIR="$APP_ROOT/shared"
            SHARED_ENV="$SHARED_DIR/.env.local"
            ACTIVE_PORT_FILE="$APP_ROOT/.active-port"
            CURRENT_LINK="$APP_ROOT/current"
            NGINX_UPSTREAM_CONF=/etc/nginx/conf.d/loomi-upstream.conf

            mkdir -p "$RELEASES_DIR" "$SHARED_DIR"

            # Ensure nginx allows uploads up to 10MB (default is 1MB)
            if [ ! -f /etc/nginx/conf.d/client-max-body-size.conf ]; then
              echo 'client_max_body_size 10m;' > /etc/nginx/conf.d/client-max-body-size.conf
              nginx -t && systemctl reload nginx
            fi

            # Keep a shared env file that all releases can reuse.
            if [ -f "$APP_ROOT/.env.local" ] && [ ! -f "$SHARED_ENV" ]; then
              cp "$APP_ROOT/.env.local" "$SHARED_ENV"
            fi
            if [ ! -f "$SHARED_ENV" ]; then
              echo "ERROR: Missing shared env file at $SHARED_ENV"
              exit 1
            fi

            cd "$APP_ROOT"

            echo "=== Pre-deploy: current commit ==="
            git log --oneline -1

            git fetch origin main
            NEW_SHA=$(git rev-parse origin/main)
            SHORT_SHA=$(echo "$NEW_SHA" | cut -c1-7)
            RELEASE_ID="$(date +%Y%m%d%H%M%S)-$SHORT_SHA"
            NEW_RELEASE="$RELEASES_DIR/$RELEASE_ID"

            # Reset any locally-modified tracked files (e.g. package-lock.json
            # dirtied by npm install) so git pull doesn't abort.
            git checkout -- .
            git pull --ff-only origin main

            echo "=== Post-pull: latest commit ==="
            git log --oneline -1

            mkdir -p "$NEW_RELEASE"
            git archive "$NEW_SHA" | tar -x -C "$NEW_RELEASE"
            cp "$SHARED_ENV" "$NEW_RELEASE/.env.local"

            cd "$NEW_RELEASE"

            npm install --legacy-peer-deps

            # Load env vars for build/runtime (Prisma needs DATABASE_URL, etc.)
            set -a && source .env.local && set +a

            npm run build

            echo "=== Build complete, .next dir size ==="
            du -sh .next

            CURRENT_PORT=3000
            if [ -f "$ACTIVE_PORT_FILE" ]; then
              CURRENT_PORT=$(cat "$ACTIVE_PORT_FILE")
            fi
            if [ "$CURRENT_PORT" != "3000" ] && [ "$CURRENT_PORT" != "3001" ]; then
              CURRENT_PORT=3000
            fi

            if [ "$CURRENT_PORT" = "3000" ]; then
              NEXT_PORT=3001
              NEXT_APP=loomi-studio-green
              OLD_APP=loomi-studio-blue
            else
              NEXT_PORT=3000
              NEXT_APP=loomi-studio-blue
              OLD_APP=loomi-studio-green
            fi

            echo "=== Starting candidate app: $NEXT_APP on port $NEXT_PORT ==="
            pm2 stop "$NEXT_APP" || true
            pm2 delete "$NEXT_APP" || true
            NODE_ENV=production pm2 start ./node_modules/.bin/next --name "$NEXT_APP" --cwd "$NEW_RELEASE" -- start -p "$NEXT_PORT"

            echo "=== Waiting for candidate health ==="
            CANDIDATE_OK=0
            i=0
            while [ $i -lt 60 ]; do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:$NEXT_PORT/api/auth/session" || true)
              if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 500 ]; then
                CANDIDATE_OK=1
                break
              fi
              sleep 2
              i=$((i + 1))
            done
            if [ "$CANDIDATE_OK" -ne 1 ]; then
              echo "ERROR: Candidate never became healthy on port $NEXT_PORT"
              echo "=== PM2 logs for $NEXT_APP ==="
              pm2 logs "$NEXT_APP" --nostream --lines 40 || true
              pm2 stop "$NEXT_APP" || true
              pm2 delete "$NEXT_APP" || true
              exit 1
            fi

            echo "=== Updating nginx upstream to port $NEXT_PORT ==="
            TARGET_CONF_COUNT=$(grep -RslE "proxy_pass http://(127\\.0\\.0\\.1|localhost):(3000|3001);|proxy_pass http://loomi_upstream;" /etc/nginx/sites-enabled /etc/nginx/conf.d | wc -l || true)
            if [ "$TARGET_CONF_COUNT" -eq 0 ]; then
              echo "ERROR: Could not find Loomi nginx proxy_pass block"
              exit 1
            fi

            grep -RslE "proxy_pass http://(127\\.0\\.0\\.1|localhost):(3000|3001);|proxy_pass http://loomi_upstream;" /etc/nginx/sites-enabled /etc/nginx/conf.d | while read -r file; do
              sed -i -E "s#proxy_pass http://(127\\.0\\.0\\.1|localhost):(3000|3001);#proxy_pass http://loomi_upstream;#g" "$file"
            done

            if [ -f "$NGINX_UPSTREAM_CONF" ]; then
              cp "$NGINX_UPSTREAM_CONF" "${NGINX_UPSTREAM_CONF}.bak"
            fi
            cat > "$NGINX_UPSTREAM_CONF" <<EOF
            upstream loomi_upstream {
              server 127.0.0.1:${NEXT_PORT};
              keepalive 64;
            }
            EOF

            if ! nginx -t; then
              echo "ERROR: nginx config test failed"
              if [ -f "${NGINX_UPSTREAM_CONF}.bak" ]; then
                mv "${NGINX_UPSTREAM_CONF}.bak" "$NGINX_UPSTREAM_CONF"
              fi
              exit 1
            fi
            systemctl reload nginx
            rm -f "${NGINX_UPSTREAM_CONF}.bak" || true

            ln -sfn "$NEW_RELEASE" "$CURRENT_LINK"
            echo "$NEXT_PORT" > "$ACTIVE_PORT_FILE"

            echo "=== Edge health check after cutover ==="
            EDGE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1/api/auth/session" || true)
            if [ "$EDGE_CODE" -lt 200 ] || [ "$EDGE_CODE" -ge 500 ]; then
              echo "ERROR: Edge health failed with HTTP $EDGE_CODE, rolling back traffic"
              cat > "$NGINX_UPSTREAM_CONF" <<EOF
            upstream loomi_upstream {
              server 127.0.0.1:${CURRENT_PORT};
              keepalive 64;
            }
            EOF
              nginx -t && systemctl reload nginx
              pm2 stop "$NEXT_APP" || true
              pm2 delete "$NEXT_APP" || true
              echo "$CURRENT_PORT" > "$ACTIVE_PORT_FILE"
              exit 1
            fi

            echo "=== Cutover complete, stopping old app ==="
            pm2 stop "$OLD_APP" || true
            pm2 delete "$OLD_APP" || true
            # Legacy process name from old deploy flow.
            pm2 stop loomi-studio || true
            pm2 delete loomi-studio || true

            echo "=== PM2 process status ==="
            pm2 save
            pm2 list

            echo "=== Release cleanup (keep latest 5) ==="
            OLD_RELEASES=$(ls -1dt "$RELEASES_DIR"/* 2>/dev/null | tail -n +6 || true)
            if [ -n "$OLD_RELEASES" ]; then
              echo "$OLD_RELEASES" | xargs rm -rf
            fi
