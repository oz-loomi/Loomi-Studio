name: ESP Verify

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DATABASE_URL: file:./prisma/dev.db

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Prepare SQLite schema
        run: |
          rm -f prisma/dev.db prisma/dev.db-wal prisma/dev.db-shm
          for file in prisma/migrations/*/migration.sql; do
            sqlite3 prisma/dev.db < "$file"
          done

      - name: Run ESP verification gate
        run: npm run esp:verify
