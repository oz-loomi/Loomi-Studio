name: YAG Rollup Sync

on:
  schedule:
    - cron: '15 * * * *' # hourly incremental
    - cron: '45 3 * * *' # nightly full reconcile
  workflow_dispatch:
    inputs:
      full_sync:
        description: Run full sync
        required: false
        default: false
        type: boolean
      dry_run:
        description: Dry run only (no writes)
        required: false
        default: false
        type: boolean
      wipe_before_sync:
        description: Wipe YAG target contacts before sync
        required: false
        default: false
        type: boolean
      wipe_mode:
        description: Wipe mode
        required: false
        default: tagged
        type: choice
        options:
          - tagged
          - all
      wipe_dry_run:
        description: Dry run wipe only (no deletes)
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Resolve mode
        id: mode
        run: |
          set -euo pipefail

          FULL_SYNC="false"
          DRY_RUN="false"
          WIPE_BEFORE_SYNC="false"
          WIPE_MODE="tagged"
          WIPE_DRY_RUN="false"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.full_sync }}" = "true" ]; then FULL_SYNC="true"; fi
            if [ "${{ inputs.dry_run }}" = "true" ]; then DRY_RUN="true"; fi
            if [ "${{ inputs.wipe_before_sync }}" = "true" ]; then WIPE_BEFORE_SYNC="true"; fi
            if [ "${{ inputs.wipe_mode }}" = "all" ]; then WIPE_MODE="all"; fi
            if [ "${{ inputs.wipe_dry_run }}" = "true" ]; then WIPE_DRY_RUN="true"; fi
          elif [ "${{ github.event.schedule }}" = "45 3 * * *" ]; then
            FULL_SYNC="true"
          fi

          echo "full_sync=$FULL_SYNC" >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"
          echo "wipe_before_sync=$WIPE_BEFORE_SYNC" >> "$GITHUB_OUTPUT"
          echo "wipe_mode=$WIPE_MODE" >> "$GITHUB_OUTPUT"
          echo "wipe_dry_run=$WIPE_DRY_RUN" >> "$GITHUB_OUTPUT"

      - name: Optional target wipe
        if: ${{ steps.mode.outputs.wipe_before_sync == 'true' }}
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -euo pipefail

            cd /var/www/loomi-studio
            set -a && source .env.local && set +a
            WIPE_DRY_RUN='${{ steps.mode.outputs.wipe_dry_run }}' \
            WIPE_MODE='${{ steps.mode.outputs.wipe_mode }}' \
            npx tsx -e "import { runYagRollupWipe } from './src/lib/services/yag-rollup'; const dryRun = process.env.WIPE_DRY_RUN === 'true'; const mode = process.env.WIPE_MODE === 'all' ? 'all' : 'tagged'; const result = await runYagRollupWipe({ dryRun, mode }); console.log(JSON.stringify(result)); if (result.status === 'failed') process.exit(1);"

      - name: Trigger sync endpoint
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 35m
          script: |
            set -euo pipefail

            cd /var/www/loomi-studio
            set -a && source .env.local && set +a
            FULL_SYNC='${{ steps.mode.outputs.full_sync }}' \
            DRY_RUN='${{ steps.mode.outputs.dry_run }}' \
            npx tsx -e "import { runYagRollupSync } from './src/lib/services/yag-rollup'; const fullSync = process.env.FULL_SYNC === 'true'; const dryRun = process.env.DRY_RUN === 'true'; const result = await runYagRollupSync({ fullSync, dryRun }); console.log(JSON.stringify(result)); if (result.status === 'failed') process.exit(1);"
