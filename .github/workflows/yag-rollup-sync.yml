name: YAG Rollup Sync

on:
  schedule:
    - cron: '15 * * * *' # hourly incremental
    - cron: '45 3 * * *' # nightly full reconcile
  workflow_dispatch:
    inputs:
      full_sync:
        description: Run full sync
        required: false
        default: false
        type: boolean
      dry_run:
        description: Dry run only (no writes)
        required: false
        default: false
        type: boolean
      wipe_before_sync:
        description: Wipe YAG target contacts before sync
        required: false
        default: false
        type: boolean
      wipe_mode:
        description: Wipe mode
        required: false
        default: tagged
        type: choice
        options:
          - tagged
          - all
      wipe_dry_run:
        description: Dry run wipe only (no deletes)
        required: false
        default: false
        type: boolean

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Resolve mode
        id: mode
        run: |
          set -euo pipefail

          FULL_SYNC="false"
          DRY_RUN="false"
          WIPE_BEFORE_SYNC="false"
          WIPE_MODE="tagged"
          WIPE_DRY_RUN="false"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.full_sync }}" = "true" ]; then FULL_SYNC="true"; fi
            if [ "${{ inputs.dry_run }}" = "true" ]; then DRY_RUN="true"; fi
            if [ "${{ inputs.wipe_before_sync }}" = "true" ]; then WIPE_BEFORE_SYNC="true"; fi
            if [ "${{ inputs.wipe_mode }}" = "all" ]; then WIPE_MODE="all"; fi
            if [ "${{ inputs.wipe_dry_run }}" = "true" ]; then WIPE_DRY_RUN="true"; fi
          elif [ "${{ github.event.schedule }}" = "45 3 * * *" ]; then
            FULL_SYNC="true"
          fi

          echo "full_sync=$FULL_SYNC" >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"
          echo "wipe_before_sync=$WIPE_BEFORE_SYNC" >> "$GITHUB_OUTPUT"
          echo "wipe_mode=$WIPE_MODE" >> "$GITHUB_OUTPUT"
          echo "wipe_dry_run=$WIPE_DRY_RUN" >> "$GITHUB_OUTPUT"

      - name: Optional target wipe
        if: ${{ steps.mode.outputs.wipe_before_sync == 'true' }}
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -euo pipefail

            cd /var/www/loomi-studio
            set -a && source .env.local && set +a

            if [ -z "${INTERNAL_JOB_SECRET:-}" ]; then
              INTERNAL_JOB_SECRET="$(openssl rand -hex 32)"
              if grep -q '^INTERNAL_JOB_SECRET=' .env.local; then
                sed -i "s|^INTERNAL_JOB_SECRET=.*$|INTERNAL_JOB_SECRET=${INTERNAL_JOB_SECRET}|" .env.local
              else
                printf '\nINTERNAL_JOB_SECRET=%s\n' "${INTERNAL_JOB_SECRET}" >> .env.local
              fi
            fi

            export INTERNAL_JOB_SECRET
            pm2 restart loomi-studio --update-env || true
            sleep 3

            WIPE_CONFIRM_ALL="false"
            if [ "${{ steps.mode.outputs.wipe_mode }}" = "all" ] && [ "${{ steps.mode.outputs.wipe_dry_run }}" = "false" ]; then
              WIPE_CONFIRM_ALL="true"
            fi

            PAYLOAD=$(printf '{"dryRun":%s,"mode":"%s","confirmAll":%s}' '${{ steps.mode.outputs.wipe_dry_run }}' '${{ steps.mode.outputs.wipe_mode }}' "$WIPE_CONFIRM_ALL")

            curl --fail --show-error --silent \
              -X POST "http://127.0.0.1:3000/api/internal/yag-rollup/wipe" \
              -H "Content-Type: application/json" \
              -H "x-internal-job-secret: ${INTERNAL_JOB_SECRET}" \
              -d "$PAYLOAD"

      - name: Trigger sync endpoint
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_HOST }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 35m
          script: |
            set -euo pipefail

            cd /var/www/loomi-studio
            set -a && source .env.local && set +a

            if [ -z "${INTERNAL_JOB_SECRET:-}" ]; then
              INTERNAL_JOB_SECRET="$(openssl rand -hex 32)"
              if grep -q '^INTERNAL_JOB_SECRET=' .env.local; then
                sed -i "s|^INTERNAL_JOB_SECRET=.*$|INTERNAL_JOB_SECRET=${INTERNAL_JOB_SECRET}|" .env.local
              else
                printf '\nINTERNAL_JOB_SECRET=%s\n' "${INTERNAL_JOB_SECRET}" >> .env.local
              fi
            fi

            export INTERNAL_JOB_SECRET
            pm2 restart loomi-studio --update-env || true
            sleep 3

            PAYLOAD=$(printf '{"fullSync":%s,"dryRun":%s}' '${{ steps.mode.outputs.full_sync }}' '${{ steps.mode.outputs.dry_run }}')

            curl --fail --show-error --silent \
              -X POST "http://127.0.0.1:3000/api/internal/yag-rollup/sync" \
              -H "Content-Type: application/json" \
              -H "x-internal-job-secret: ${INTERNAL_JOB_SECRET}" \
              -d "$PAYLOAD"
